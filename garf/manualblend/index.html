<head>
  <style>
    .panel {
      width: 250px;
      height: 216px;
      object-fit: cover;
    }

    .panel-container {
      overflow: hidden;
    }

    .panel-container:hover .toolbar {
      display: block;
    }

    .left {
      object-position: -1%;
    }

    .middle {
      object-position: unset;
    }

    .right {
      object-position: 102%;
    }

    .yeet {
      object-position: -145px -73px;
      transform: scale(3.3);
    }

    .observe {
      object-position: 81px -73px;
      transform: scale(3.3);
    }

    .none {
      visibility: hidden;
    }

    .strip {
      display: flex;
      width: fit-content;
    }

    .toolbar {
      display: none;
      margin: 20px;

    }

    a,
    a:visited {
      color: unset;
    }

    .linkbar {
      margin: 10px;
    }
  </style>
</head>
<template class="panel-container">
  <a id="link{n}" target="_blank">
    <div style="overflow: hidden;"><img class="panel" id="panel{n}"></img></div>
  </a>
  <div class="toolbar">
      <a href="#" onclick="swap({n}, -1);">&leftarrow;</a>
        <a href="#" onclick="hold({n});">Hold</a>
        <a href="#" onclick="unhold({n});">Free</a>
        <a href="#" onclick="roll({n});">Roll</a>
        <a href="#" onclick="megaroll({n});">Megaroll</a>
      <a href="#" onclick="swap({n}, 1);">&rightarrow;</a>
    <ul>
      <li><a href="#" onclick="hot({n},'none');">(None)</a></li>
      <li><a href="#" onclick="hot({n},'blender');">Blender</a></li>
      <li><a href="#" onclick="hot({n},'nature');">Graphic nature</a></li>
      <!-- <li><a href="#" onclick="hot({n},'nopics');">No pictures</a></li> -->
      <li><a href="#" onclick="hot({n},'five');">Five minutes later</a></li>
      <li><a href="#" onclick="hot({n},'dead');">Dead</a></li>
      <li><a href="#" onclick="hot({n},'concern');">Concern</a></li>
      <li><a href="#" onclick="hot({n},'yeet');">Yeet</a></li>
      <li><a href="#" onclick="hot({n},'observe');">Observe</a></li>
      <li><a href="#" onclick="hot({n},'nightmare');">Nightmare</a></li>
    </ul>
  </div>
</template>

<body id="body">
  <div class="linkbar">
    <a id="permalink">Link to strip</a>
    <a href="?d=random">Random</a>
    <a href="?d=random&p0=random&p1=random&p2=random">Megarandom</a>
    <a href="?d=random&p0=megarandom&p1=megarandom&p2=megarandom">Omegarandom</a>
    <a href="">Refresh</a>
  </div>
  <div class="strip">

  </div>
  </div>
  <script>
    randomDate = function () {
      do {
        var date = new Date(+Date.parse("1978-06-19") + Math.random() * (Date.now() - Date.parse("1978-06-19")));
      } while (date.getDay() == 0);
      var datestring = date.getFullYear().toString().slice(2) + ("0" + (date.getMonth() + 1)).slice(-2) + ("0" + date.getDate()).slice(-2);
      return datestring;
    }
    getDate = function () {
      date = urlParams.get('d');
      return date;
    }
    getSpecial = function (n) {
      p = urlParams.get(`p${n}`);
      return p;
    }
    setPanel = function (d, n0, n1, ext) {
      ar = d.slice(0, 2);
      if (ar < 78) year = "20" + ar; else year = "19" + ar;
      if (!ext) ext = 'gif';
      url = `http://picayune.uclick.com/comics/ga/${year}/ga${d}.${ext}`;
      document.getElementById(`panel${n1}`).src = url;
      document.getElementById(`link${n1}`).href = url;
      if (n0 == 0) document.getElementById(`panel${n1}`).classList.add("left");
      if (n0 == 1) document.getElementById(`panel${n1}`).classList.add("middle");
      if (n0 == 2) document.getElementById(`panel${n1}`).classList.add("right");
    }
    resolvePanel = function (n1) {
      document.getElementById(`panel${n1}`).classList.remove('yeet');
      special = getSpecial(n1);
      if (special == null) {
        n0 = n1;
        d = getDate();
        if (d == "random") d = randoms[0][0];
      }
      else if (special == 'random') {
        n0 = n1;
        d = randoms[n1 + 1][0];
      }
      else if (special == 'megarandom') {
        n0 = randoms[n1 + 1][1];
        d = randoms[n1 + 1][0];
      }
      else if (special == 'none') {
        n0 = n1;
        d = randoms[n1 + 1][0];
        document.getElementById(`panel${n1}`).classList.add('none');
      }
      else if (special == 'blender') {
        n0 = 0;
        d = '080426';
      }
      else if (special == 'nature') {
        n0 = 1;
        d = '050430';
      }
      else if (special == 'nopics') {
        n0 = 2;
        d = '061021';
      }
      else if (special == 'five') {
        n0 = 1;
        d = '151221';
      }
      else if (special == 'dead') {
        n0 = 0;
        d = '130408';
      }
      else if (special == 'concern') {
        n0 = 1;
        d = '991211';
      }
      else if (special == 'yeet') {
        n0 = 2;
        d = '810329';
        document.getElementById(`panel${n1}`).classList.add('yeet');
      }
      else if (special == 'observe') {
        n0 = 2;
        d = '230423';
        document.getElementById(`panel${n1}`).classList.add('observe');
        var ext = 'jpg';
      }
      else if (special == 'nightmare') {
        n0 = 2;
        d = '240212';
      }
      else {
        n0 = special.split('-')[1];
        if (n0 == undefined) n0 = n1;
        d = special.split('-')[0];
      }

      setPanel(d, n0, n1, ext);
    }

    getLink = function (isPerma) {
      let returnParams;
      if (isPerma) {
        bakePermaParams();
        returnParams = permaParams;
      }
      else {
        returnParams = urlParams;
      }
      return `${window.location.origin}${window.location.pathname}?${returnParams.toString()}`;
    }

    bakePermaParams = function () {
      ['d', 'p0', 'p1', 'p2'].forEach(function (param, index) {
        if (urlParams.has(param)) {
          value = urlParams.get(param);
          if (value == 'random') value = randoms[index][0];
          if (value == 'megarandom') value = randoms[index].join('-');
          if (parseInt(value) && !value.includes('-'))  // panelless date
            if (param.length == 2)
              value += `-${param[1]}`;  
          permaParams.set(param, value);
        }
      });
    }

    generateLink = function () {
      document.getElementById('permalink').href = getLink(isPerma = true);
    }
    hold = function (n) {
      url = window.location.href;
      if (urlParams.has(`p${n}`)) {
        if (urlParams.get(`p${n}`) == 'random') {
          urlParams.set(`p${n}`, `${randoms[n + 1][0]}`);
        }
        if (urlParams.get(`p${n}`) == 'megarandom') {
          urlParams.set(`p${n}`, `${randoms[n + 1].join('-')}`);
        }
      }
      else if (urlParams.has('d')) {
        d = urlParams.get('d');
        if (d != "random")
          urlParams.set(`p${n}`, `${d}-${n}`);
        else {
          urlParams.set(`p${n}`, `${randoms[0][0]}-${n}`);
        }
      }
      window.location.href = getLink(isPerma = false);
    }
    unhold = function (n) {
      urlParams.delete(`p${n}`);
      window.location.href = getLink(isPerma = false);
    }
    roll = function (n) {
      urlParams.set(`p${n}`, 'random');
      window.location.href = getLink(isPerma = false);
    }
    megaroll = function (n) {
      urlParams.set(`p${n}`, 'megarandom');
      window.location.href = getLink(isPerma = false);
    }

    hot = function (n, panelName) {
      url = window.location.href;
      urlParams.set(`p${n}`, `${panelName}`);
      window.location.href = getLink(isPerma = false);
    }
    swap = function (n, dir) {
      n_ = (((n + dir) % 3) + 3) % 3;
      if (!urlParams.has(`p${n}`)) urlParams.set(`p${n}`, `${randoms[0][0]}-${n}`);
      if (!urlParams.has(`p${n_}`)) urlParams.set(`p${n_}`, `${randoms[0][0]}-${n_}`);
      bakePermaParams();
      urlParams.set(`p${n_}`, `${permaParams.get(`p${n}`)}`);
      urlParams.set(`p${n}`, `${permaParams.get(`p${n_}`)}`);
      // urlParams.set(`p${n_}`, `${randoms[n + 1].join('-')}`);
      // urlParams.set(`p${n}`, `${randoms[n_ + 1].join('-')}`);
      window.location.href = getLink(isPerma = false);
    }

    window.onload = function () {
      temp = document.getElementsByTagName("template")[0];
      tempText = temp.innerHTML;
      for (let i = 0; i < 3; i++) {
        let instanceText = tempText.replaceAll('{n}', i);
        let instance = document.createElement('div');
        instance.classList.add('panel-container');
        instance.innerHTML = instanceText;
        document.getElementsByClassName('strip')[0].appendChild(instance);
      }

      urlParams = new URLSearchParams(window.location.search);
      permaParams = new URLSearchParams(urlParams);
      if (!urlParams.has('d')) window.location = `?d=random`;
      randoms = [
        [randomDate(), null],
        [randomDate(), Math.floor(Math.random() * 3)],
        [randomDate(), Math.floor(Math.random() * 3)],
        [randomDate(), Math.floor(Math.random() * 3)]];


      resolvePanel(0);
      resolvePanel(1);
      resolvePanel(2);
      generateLink();
    }
  </script>
</body>